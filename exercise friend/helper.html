<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
	
	@import url('https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&family=Noto+Serif:ital,wght@0,100..900;1,100..900&display=swap');

    body {
        font-family: "Noto Serif";
        color: #595941;
        background-color: #e3e3e3;
		font-size:16px;
		margin:0;
    }
	
  .accordion {
    border: 1px solid #ccc;
    margin-bottom: 10px;
  }

  .accordion-header {
    background-color: #f4f4f4;
    padding: 10px;
    cursor: pointer;
  }

  .accordion-content {
    display: none;
    padding: 10px;
  }
  
</style>

</head>
<body>

<button onclick="speak()">speak</button>

<audio id="audio" controls>
  Your browser does not support the audio element.
</audio>

<div id="stretchList">

</div>

<script>
	
  fetch('data.tsv')
    .then(response => response.text())
    .then(data => {
      const lines = data.split('\n').slice(1);
      const items = lines.map(line => {
        const [stretch, switchVal, time, reps, group] = line.split('\t');
        return { stretch, switch: switchVal, time, reps: parseInt(reps), group };
      });
      console.log(items);
	  createElements(items);
    })
    .catch(error => console.error('Error fetching the data:', error));
	
	function createElements(data) {
		
		const stretchList = document.getElementById('stretchList');

		const groupCheckboxes = {};

		data.forEach(item => {
			
			const groupName = item.group;
			console.log(groupCheckboxes[groupName]);

			if (groupCheckboxes[groupName] === undefined) {
				
		        const accordion = document.createElement('div');
		        accordion.className = 'accordion';
				
				const header = document.createElement('div');
				header.className = 'accordion-header';
				
				header.onclick = function() {
					toggleAccordion(this);
				};
				
				groupCheckboxes[groupName] = document.createElement('input');
				groupCheckboxes[groupName].type = 'checkbox';
				groupCheckboxes[groupName].checked = true;

				const groupLabel = document.createElement('label');
				groupLabel.textContent = groupName;

			    groupCheckboxes[groupName].addEventListener('change', function() {
			      const groupCheckbox = this;
			      const nestedCheckboxes = stretchList.querySelectorAll(`input[type='checkbox'][data-group='${CSS.escape(groupName)}']`);
			      nestedCheckboxes.forEach(checkbox => {
			        checkbox.checked = groupCheckbox.checked;
			      });
			    });
				
				const content = document.createElement('div');
				content.className = 'accordion-content';
      
				header.appendChild(groupCheckboxes[groupName]);
				header.appendChild(groupLabel);
				accordion.appendChild(header);
				accordion.appendChild(content);
				
				groupCheckboxes[groupName] = {
					accordion: accordion,
					content: content
				};
				
				stretchList.appendChild(accordion);
				
			}

			const stretchCheckbox = document.createElement('input');
			stretchCheckbox.type = 'checkbox';
			stretchCheckbox.checked = true;
			stretchCheckbox.dataset.group = groupName;
			stretchCheckbox.dataset.time = item.time;

			const stretchLabel = document.createElement('label');
			stretchLabel.textContent = item.stretch;
			
			groupCheckboxes[groupName].content.appendChild(stretchCheckbox);
			groupCheckboxes[groupName].content.appendChild(stretchLabel);
			groupCheckboxes[groupName].content.appendChild(document.createElement('br'));
			
			console.log(groupCheckboxes[groupCheckboxes[groupName].content]);
			
		});
	}
	
	function toggleAccordion(header) {
	  const content = header.nextElementSibling;
	  if (content.style.display === "block") {
	    content.style.display = "none";
	  } else {
	    content.style.display = "block";
	  }
	}
	
	function speak() {
		var textList = document.querySelectorAll("#stretchList input[type='checkbox']");
		var ssml = '<speak>';

		textList.forEach(item => {
			
			const checkbox = item;
			const text = item.nextSibling.textContent.trim();

			if ((checkbox.dataset.group != undefined) & (checkbox.checked)) {
				ssml += text + ' ';
			}
		});

		ssml += '</speak>';

		var xhr = new XMLHttpRequest();
		var url = "https://texttospeech.googleapis.com/v1/text:synthesize?key=AIzaSyCcCQFbNls8ogpWJTshCm2ZTQLnx1x3tzE";

	    xhr.open("POST", url, true);
	    xhr.setRequestHeader("Content-Type", "application/json");

	    xhr.onreadystatechange = function () {
	      if (xhr.readyState === 4 && xhr.status === 200) {
	        var response = JSON.parse(xhr.responseText);
	        var audioUrl = "data:audio/mp3;base64," + response.audioContent;
	        document.getElementById("audio").src = audioUrl;
	        document.getElementById("audio").play();
	      }
	    };

	    var data = JSON.stringify({
	      input: { ssml: ssml },
	      voice: { languageCode: "en-US", ssmlGender: "NEUTRAL" },
	      audioConfig: { audioEncoding: "MP3" }
	    });

	    xhr.send(data);
	}

</script>

</body>
</html>
